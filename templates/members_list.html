{% extends "base.html" %}

{% block title %}Members - MLS3{% endblock %}

{% block content %}
<div class="container">
    <h1 id="page-title">Members <span id="member-count" class="text-muted" style="font-size: 0.7em;">({{ active_count }})</span></h1>

    <div class="filters">
        <button class="btn btn-secondary filters-toggle" id="filters-toggle">
            <span id="filters-toggle-text">Show Filters</span>
        </button>

        <div class="filters-collapsible" id="filters-collapsible">
            <div class="filter-buttons">
                <button class="btn btn-filter active" id="filter-active-status">Active: Yes</button>
                <button class="btn btn-filter" id="filter-gender">Gender: All</button>
                <button class="btn btn-filter" id="filter-minors">Minors: No</button>
                <button class="btn btn-filter" id="filter-prayed">Prayed: All</button>
                <button class="btn btn-filter" id="filter-flag">Flag: All</button>
                <button class="btn btn-filter" id="filter-name-format">Name Format</button>
            </div>
            <div class="sort-buttons" style="margin-bottom: 0.75rem;">
                <button class="btn btn-sort" id="sort-alpha" title="Sort alphabetically">Aâ†’Z</button>
                <button class="btn btn-sort" id="sort-prayer" title="Sort by prayer date">Prayer Date â–¼</button>
            </div>
        </div>

        <div class="search-container">
            <input type="text" id="search-box" placeholder="Search members..." class="search-input">
            <button class="search-clear-btn" id="search-clear-btn" title="Clear search">&times;</button>
        </div>
    </div>

    <div class="members-grid" id="members-grid">
        {% for member in members %}
        <div class="member-card clickable {% if not member.active %}inactive-member{% endif %}"
             data-gender="{{ member.gender }}"
             data-name="{{ member.full_name|lower }}"
             data-first-name="{{ member.first_name|lower }}"
             data-last-name="{{ member.last_name|lower }}"
             data-first-name-display="{{ member.display_name }}"
             data-last-name-display="{{ member.last_name }}"
             data-prayer-date="{{ member.last_prayer_date if member.last_prayer_date else '1900-01-01' }}"
             data-active="{{ 'true' if member.active else 'false' }}"
             data-age="{{ member.age if member.age is not none else '999' }}"
             data-is-minor="{{ 'true' if member.age is not none and member.age < 18 else 'false' }}"
             data-has-prayed="{{ 'true' if member.last_prayer_date else 'false' }}"
             data-flag="{{ member.flag if member.flag else '' }}"
             onclick="openMemberModal({{ member.member_id }})">
            {% if member.flag %}
            <div class="flag-circles-container">
                {% for flag_color in member.flag.split(',') %}
                <span class="flag-circle flag-{{ flag_color.strip() }}"></span>
                {% endfor %}
            </div>
            {% endif %}
            <h3>{{ member.full_name }}{% if not member.active %} <span class="inactive-badge">Inactive</span>{% endif %}</h3>
            {% if member.age is not none %}
            <p><strong>Age:</strong> {% if member.age < 18 %}<span class="minor-age">{{ member.age }}</span>{% else %}{{ member.age }}{% endif %}</p>
            {% else %}
            <p><strong>Age:</strong> <span class="text-muted">Unknown</span></p>
            {% endif %}
            <p><strong>Gender:</strong> {{ member.gender }}</p>
            <p><strong>Phone:</strong> {{ member.phone }}</p>
            {% if member.last_prayer_date %}
            <p><strong>Last Prayer:</strong> {{ member.last_prayer_date }}</p>
            {% else %}
            <p><strong>Last Prayer:</strong> <span class="text-muted">Never</span></p>
            {% endif %}
            {% if member.dont_ask_prayer %}
            <p class="warning">âš  Don't ask for prayers</p>
            {% endif %}
            {% if member.notes %}
            <p class="notes">{{ member.notes }}</p>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Filter and sort functionality
    const memberCards = Array.from(document.querySelectorAll('.member-card'));
    const searchBox = document.getElementById('search-box');
    const membersGrid = document.getElementById('members-grid');
    const sortAlphaBtn = document.getElementById('sort-alpha');
    const sortPrayerBtn = document.getElementById('sort-prayer');

    // Filter buttons
    const filterActiveBtn = document.getElementById('filter-active-status');
    const filterGenderBtn = document.getElementById('filter-gender');
    const filterMinorsBtn = document.getElementById('filter-minors');
    const filterPrayedBtn = document.getElementById('filter-prayed');
    const filterFlagBtn = document.getElementById('filter-flag');
    const filterNameFormatBtn = document.getElementById('filter-name-format');

    // Load filter state from sessionStorage or use defaults
    const savedFilters = sessionStorage.getItem('memberListFilters');
    let filterState = savedFilters ? JSON.parse(savedFilters) : {
        activeFilter: 'active',
        genderFilter: 'all',
        minorsFilter: 'no',  // 'no', 'yes', 'only'
        prayerHistoryFilter: 'all',
        flagFilter: 'all',
        alphaSort: null,
        prayerSort: null,
        searchTerm: '',
        nameFormat: 'first-last'  // 'first-last' or 'last-first'
    };

    // Filter states
    let activeFilter = filterState.activeFilter;
    let genderFilter = filterState.genderFilter;
    let minorsFilter = filterState.minorsFilter || 'no';
    let prayerHistoryFilter = filterState.prayerHistoryFilter;
    let flagFilter = filterState.flagFilter;
    let alphaSort = filterState.alphaSort;
    let prayerSort = filterState.prayerSort;
    let nameFormat = filterState.nameFormat || 'first-last';

    // Restore search box value
    if (filterState.searchTerm) {
        searchBox.value = filterState.searchTerm;
    }

    // Initialize clear button visibility
    const searchClearBtn = document.getElementById('search-clear-btn');
    if (searchBox.value.trim()) {
        searchClearBtn.classList.add('visible');
    }

    // Filters collapse/expand functionality
    const filtersToggle = document.getElementById('filters-toggle');
    const filtersToggleText = document.getElementById('filters-toggle-text');
    const filtersCollapsible = document.getElementById('filters-collapsible');
    let filtersExpanded = sessionStorage.getItem('filtersExpanded') === 'true';

    // Set initial state
    if (filtersExpanded) {
        filtersCollapsible.classList.add('expanded');
        filtersToggleText.textContent = 'Hide Filters';
    }

    filtersToggle.addEventListener('click', () => {
        filtersExpanded = !filtersExpanded;
        if (filtersExpanded) {
            filtersCollapsible.classList.add('expanded');
            filtersToggleText.textContent = 'Hide Filters';
        } else {
            filtersCollapsible.classList.remove('expanded');
            filtersToggleText.textContent = 'Show Filters';
        }
        sessionStorage.setItem('filtersExpanded', filtersExpanded);
    });

    // Function to save filter state
    function saveFilterState() {
        const state = {
            activeFilter,
            genderFilter,
            minorsFilter,
            prayerHistoryFilter,
            flagFilter,
            alphaSort,
            prayerSort,
            searchTerm: searchBox.value,
            nameFormat
        };
        sessionStorage.setItem('memberListFilters', JSON.stringify(state));
    }

    // Restore button labels based on saved state
    function restoreButtonLabels() {
        // Active filter
        if (activeFilter === 'active') {
            filterActiveBtn.textContent = 'Active: Yes';
            filterActiveBtn.classList.add('active');
        } else if (activeFilter === 'inactive') {
            filterActiveBtn.textContent = 'Active: No';
            filterActiveBtn.classList.add('active');
        } else {
            filterActiveBtn.textContent = 'Active: All';
            filterActiveBtn.classList.remove('active');
        }

        // Gender filter
        if (genderFilter === 'M') {
            filterGenderBtn.textContent = 'Gender: M';
            filterGenderBtn.classList.add('active');
        } else if (genderFilter === 'F') {
            filterGenderBtn.textContent = 'Gender: F';
            filterGenderBtn.classList.add('active');
        } else {
            filterGenderBtn.textContent = 'Gender: All';
            filterGenderBtn.classList.remove('active');
        }

        // Minors filter
        if (minorsFilter === 'yes') {
            filterMinorsBtn.textContent = 'Minors: Yes';
            filterMinorsBtn.classList.add('active');
        } else if (minorsFilter === 'only') {
            filterMinorsBtn.textContent = 'Minors: Only';
            filterMinorsBtn.classList.add('active');
        } else {
            filterMinorsBtn.textContent = 'Minors: No';
            filterMinorsBtn.classList.remove('active');
        }

        // Prayer history filter
        if (prayerHistoryFilter === 'prayed') {
            filterPrayedBtn.textContent = 'Prayed: Yes';
            filterPrayedBtn.classList.add('active');
        } else if (prayerHistoryFilter === 'never') {
            filterPrayedBtn.textContent = 'Prayed: No';
            filterPrayedBtn.classList.add('active');
        } else {
            filterPrayedBtn.textContent = 'Prayed: All';
            filterPrayedBtn.classList.remove('active');
        }

        // Flag filter
        if (flagFilter === 'blue') {
            filterFlagBtn.textContent = 'Flag: ðŸ”µ';
            filterFlagBtn.classList.add('active');
        } else if (flagFilter === 'yellow') {
            filterFlagBtn.textContent = 'Flag: ðŸŸ¡';
            filterFlagBtn.classList.add('active');
        } else if (flagFilter === 'red') {
            filterFlagBtn.textContent = 'Flag: ðŸ”´';
            filterFlagBtn.classList.add('active');
        } else {
            filterFlagBtn.textContent = 'Flag: All';
            filterFlagBtn.classList.remove('active');
        }

        // Name format button
        if (nameFormat === 'last-first') {
            filterNameFormatBtn.classList.add('active');
        } else {
            filterNameFormatBtn.classList.remove('active');
        }

        // Sort buttons
        if (alphaSort === 'asc') {
            sortAlphaBtn.textContent = 'Aâ†’Z';
            sortAlphaBtn.classList.add('active');
        } else if (alphaSort === 'desc') {
            sortAlphaBtn.textContent = 'Zâ†’A';
            sortAlphaBtn.classList.add('active');
        } else {
            sortAlphaBtn.textContent = 'Aâ†’Z';
            sortAlphaBtn.classList.remove('active');
        }

        if (prayerSort === 'asc') {
            sortPrayerBtn.textContent = 'Prayer Date â–²';
            sortPrayerBtn.classList.add('active');
        } else if (prayerSort === 'desc') {
            sortPrayerBtn.textContent = 'Prayer Date â–¼';
            sortPrayerBtn.classList.add('active');
        } else {
            sortPrayerBtn.textContent = 'Prayer Date â–¼';
            sortPrayerBtn.classList.remove('active');
        }
    }

    // Restore button labels on page load
    restoreButtonLabels();

    // Active status button - cycles through yes -> no -> all
    filterActiveBtn.addEventListener('click', () => {
        if (activeFilter === 'active') {
            activeFilter = 'inactive';
            filterActiveBtn.textContent = 'Active: No';
            filterActiveBtn.classList.add('active');
        } else if (activeFilter === 'inactive') {
            activeFilter = 'all';
            filterActiveBtn.textContent = 'Active: All';
            filterActiveBtn.classList.remove('active');
        } else {
            activeFilter = 'active';
            filterActiveBtn.textContent = 'Active: Yes';
            filterActiveBtn.classList.add('active');
        }
        saveFilterState();
        applyFiltersAndSort();
    });

    // Gender button - cycles through All -> M -> F
    filterGenderBtn.addEventListener('click', () => {
        if (genderFilter === 'all') {
            genderFilter = 'M';
            filterGenderBtn.textContent = 'Gender: M';
            filterGenderBtn.classList.add('active');
        } else if (genderFilter === 'M') {
            genderFilter = 'F';
            filterGenderBtn.textContent = 'Gender: F';
            filterGenderBtn.classList.add('active');
        } else {
            genderFilter = 'all';
            filterGenderBtn.textContent = 'Gender: All';
            filterGenderBtn.classList.remove('active');
        }
        saveFilterState();
        applyFiltersAndSort();
    });

    // Minors button - cycles through no -> yes -> only
    filterMinorsBtn.addEventListener('click', () => {
        if (minorsFilter === 'no') {
            minorsFilter = 'yes';
            filterMinorsBtn.textContent = 'Minors: Yes';
            filterMinorsBtn.classList.add('active');
        } else if (minorsFilter === 'yes') {
            minorsFilter = 'only';
            filterMinorsBtn.textContent = 'Minors: Only';
            filterMinorsBtn.classList.add('active');
        } else {
            minorsFilter = 'no';
            filterMinorsBtn.textContent = 'Minors: No';
            filterMinorsBtn.classList.remove('active');
        }
        saveFilterState();
        applyFiltersAndSort();
    });

    // Prayer history button - cycles through All -> Yes -> No
    filterPrayedBtn.addEventListener('click', () => {
        if (prayerHistoryFilter === 'all') {
            prayerHistoryFilter = 'prayed';
            filterPrayedBtn.textContent = 'Prayed: Yes';
            filterPrayedBtn.classList.add('active');
        } else if (prayerHistoryFilter === 'prayed') {
            prayerHistoryFilter = 'never';
            filterPrayedBtn.textContent = 'Prayed: No';
            filterPrayedBtn.classList.add('active');
        } else {
            prayerHistoryFilter = 'all';
            filterPrayedBtn.textContent = 'Prayed: All';
            filterPrayedBtn.classList.remove('active');
        }
        saveFilterState();
        applyFiltersAndSort();
    });

    // Flag button - cycles through All -> Blue -> Yellow -> Red
    filterFlagBtn.addEventListener('click', () => {
        if (flagFilter === 'all') {
            flagFilter = 'blue';
            filterFlagBtn.textContent = 'Flag: ðŸ”µ';
            filterFlagBtn.classList.add('active');
        } else if (flagFilter === 'blue') {
            flagFilter = 'yellow';
            filterFlagBtn.textContent = 'Flag: ðŸŸ¡';
            filterFlagBtn.classList.add('active');
        } else if (flagFilter === 'yellow') {
            flagFilter = 'red';
            filterFlagBtn.textContent = 'Flag: ðŸ”´';
            filterFlagBtn.classList.add('active');
        } else {
            flagFilter = 'all';
            filterFlagBtn.textContent = 'Flag: All';
            filterFlagBtn.classList.remove('active');
        }
        saveFilterState();
        applyFiltersAndSort();
    });

    // Name format button - toggles between First Last and Last, First
    filterNameFormatBtn.addEventListener('click', () => {
        if (nameFormat === 'first-last') {
            nameFormat = 'last-first';
            filterNameFormatBtn.classList.add('active');
        } else {
            nameFormat = 'first-last';
            filterNameFormatBtn.classList.remove('active');
        }
        updateMemberNames();
        saveFilterState();
        applyFiltersAndSort();
    });

    // Search box with fuzzy matching
    searchBox.addEventListener('input', (e) => {
        // Show/hide clear button based on whether there's text
        if (searchBox.value.trim()) {
            searchClearBtn.classList.add('visible');
        } else {
            searchClearBtn.classList.remove('visible');
        }
        saveFilterState();
        applyFiltersAndSort();
    });

    // Clear button click handler
    searchClearBtn.addEventListener('click', () => {
        searchBox.value = '';
        searchClearBtn.classList.remove('visible');
        saveFilterState();
        applyFiltersAndSort();
    });

    // Alphabetic sort toggle
    sortAlphaBtn.addEventListener('click', () => {
        // Toggle: null -> asc -> desc -> null
        if (alphaSort === null) {
            alphaSort = 'asc';
            sortAlphaBtn.textContent = 'Aâ†’Z';
            sortAlphaBtn.classList.add('active');
        } else if (alphaSort === 'asc') {
            alphaSort = 'desc';
            sortAlphaBtn.textContent = 'Zâ†’A';
        } else {
            alphaSort = null;
            sortAlphaBtn.textContent = 'Aâ†’Z';
            sortAlphaBtn.classList.remove('active');
        }

        // Clear other sort
        prayerSort = null;
        sortPrayerBtn.textContent = 'Prayer Date â†“';
        sortPrayerBtn.classList.remove('active');

        saveFilterState();
        applyFiltersAndSort();
    });

    // Prayer date sort toggle
    sortPrayerBtn.addEventListener('click', () => {
        // Toggle: null -> asc (oldest first) -> desc (newest first) -> null
        if (prayerSort === null) {
            prayerSort = 'asc';
            sortPrayerBtn.textContent = 'Prayer Date â–²';
            sortPrayerBtn.classList.add('active');
        } else if (prayerSort === 'asc') {
            prayerSort = 'desc';
            sortPrayerBtn.textContent = 'Prayer Date â–¼';
        } else {
            prayerSort = null;
            sortPrayerBtn.textContent = 'Prayer Date â–¼';
            sortPrayerBtn.classList.remove('active');
        }

        // Clear other sort
        alphaSort = null;
        sortAlphaBtn.textContent = 'Aâ†’Z';
        sortAlphaBtn.classList.remove('active');

        saveFilterState();
        applyFiltersAndSort();
    });

    // Fuzzy matching function
    function fuzzyMatch(searchTerm, card) {
        if (searchTerm === '') return true;

        // Split search term into words
        const queryWords = searchTerm.toLowerCase().split(/\s+/).filter(w => w.length > 0);
        if (queryWords.length === 0) return true;

        const firstName = card.dataset.firstName;
        const lastName = card.dataset.lastName;
        const displayName = card.dataset.firstNameDisplay.toLowerCase();

        // Include both first name and display name (AKA) for searching
        const nameParts = [firstName, lastName];
        // If display name is different from first name, add it to search
        if (displayName && displayName !== firstName) {
            nameParts.push(displayName);
        }

        // Each query word must match the start of at least one name part
        for (const queryWord of queryWords) {
            let matched = false;
            for (const namePart of nameParts) {
                if (namePart.startsWith(queryWord)) {
                    matched = true;
                    break;
                }
            }
            if (!matched) {
                return false;
            }
        }

        return true;
    }

    // Function to update all member names based on current format
    function updateMemberNames() {
        memberCards.forEach(card => {
            const h3 = card.querySelector('h3');
            const firstName = card.dataset.firstNameDisplay;
            const lastName = card.dataset.lastNameDisplay;

            // Get the inactive badge if it exists
            const inactiveBadge = h3.querySelector('.inactive-badge');

            if (nameFormat === 'last-first') {
                h3.textContent = `${lastName}, ${firstName}`;
            } else {
                h3.textContent = `${firstName} ${lastName}`;
            }

            // Re-append the inactive badge if it existed
            if (inactiveBadge) {
                h3.appendChild(document.createTextNode(' '));
                h3.appendChild(inactiveBadge);
            }
        });
    }

    // Function to get the sort key for a card based on name format
    function getSortName(card) {
        if (nameFormat === 'last-first') {
            return card.dataset.lastName.toLowerCase() + ', ' + card.dataset.firstName.toLowerCase();
        } else {
            return card.dataset.firstName.toLowerCase() + ' ' + card.dataset.lastName.toLowerCase();
        }
    }

    function applyFiltersAndSort() {
        const searchTerm = searchBox.value.toLowerCase().trim();

        // Filter cards
        let visibleCards = memberCards.filter(card => {
            const isActive = card.dataset.active === 'true';
            const gender = card.dataset.gender;
            const isMinor = card.dataset.isMinor === 'true';
            const hasPrayed = card.dataset.hasPrayed === 'true';
            const flag = card.dataset.flag;

            // Check active status filter
            let matchesActive = false;
            if (activeFilter === 'all') {
                matchesActive = true;
            } else if (activeFilter === 'active') {
                matchesActive = isActive;
            } else { // inactive
                matchesActive = !isActive;
            }

            // Check gender filter
            let matchesGender = (genderFilter === 'all' || gender === genderFilter);

            // Check minors filter
            let matchesMinors = false;
            if (minorsFilter === 'no') {
                matchesMinors = !isMinor;  // Exclude minors
            } else if (minorsFilter === 'yes') {
                matchesMinors = true;  // Include everyone
            } else { // 'only'
                matchesMinors = isMinor;  // Only minors
            }

            // Check prayer history filter
            let matchesPrayerHistory = false;
            if (prayerHistoryFilter === 'all') {
                matchesPrayerHistory = true;
            } else if (prayerHistoryFilter === 'prayed') {
                matchesPrayerHistory = hasPrayed;
            } else { // never
                matchesPrayerHistory = !hasPrayed;
            }

            // Check flag filter (member can have multiple flags)
            let matchesFlag = flagFilter === 'all';
            if (!matchesFlag && flag) {
                // Check if member has the filtered flag among their flags
                const memberFlags = flag.split(',').map(f => f.trim());
                matchesFlag = memberFlags.includes(flagFilter);
            }

            // Check search
            const matchesSearch = fuzzyMatch(searchTerm, card);

            // All filters must match
            if (matchesActive && matchesGender && matchesMinors && matchesPrayerHistory && matchesFlag && matchesSearch) {
                card.style.display = '';
                return true;
            } else {
                card.style.display = 'none';
                return false;
            }
        });

        // Update member count
        document.getElementById('member-count').textContent = `(${visibleCards.length})`;

        // Sort visible cards
        if (alphaSort !== null) {
            visibleCards.sort((a, b) => {
                const nameA = getSortName(a);
                const nameB = getSortName(b);
                if (alphaSort === 'asc') {
                    return nameA.localeCompare(nameB);
                } else {
                    return nameB.localeCompare(nameA);
                }
            });
        } else if (prayerSort !== null) {
            visibleCards.sort((a, b) => {
                const dateA = a.dataset.prayerDate;
                const dateB = b.dataset.prayerDate;
                if (prayerSort === 'asc') {
                    return dateA.localeCompare(dateB);
                } else {
                    return dateB.localeCompare(dateA);
                }
            });
        }

        // Re-append cards in sorted order
        if (alphaSort !== null || prayerSort !== null) {
            visibleCards.forEach(card => {
                membersGrid.appendChild(card);
            });
        }
    }

    // Apply initial name format and filter on page load
    updateMemberNames();
    applyFiltersAndSort();
</script>
{% endblock %}

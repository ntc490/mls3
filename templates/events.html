{% extends "base.html" %}

{% block title %}MLS3 - Events{% endblock %}

{% block content %}
<div class="container">
    <div class="scheduler-header">
        <h1>Events</h1>
    </div>

    <div class="events-filters">
        <!-- Filter Toggle Button -->
        <div class="form-row" style="margin-bottom: 1rem;">
            <div class="form-group" style="flex: 1;">
                <button id="toggleDateFiltersBtn" class="btn btn-secondary" style="width: 100%;">
                    <span id="toggleIcon">‚ñº</span> Filter/Sort
                </button>
            </div>
        </div>

        <!-- Date Filters (collapsible) -->
        <div id="dateFiltersSection" style="display: none;">
            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label for="searchText">Search</label>
                    <input type="text" id="searchText" class="form-input" placeholder="Search names and appointment types...">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="dateFrom">From Date</label>
                    <input type="date" id="dateFrom" class="form-input">
                </div>

                <div class="form-group">
                    <label for="dateTo">To Date</label>
                    <input type="date" id="dateTo" class="form-input">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <button id="applyFilterBtn" class="btn btn-primary" style="width: 100%;">Apply</button>
                </div>

                <div class="form-group" style="flex: 1;">
                    <button id="sortToggleBtn" class="btn btn-primary" data-order="desc" style="width: 100%;">Dates ‚Üì</button>
                </div>
            </div>

            <div class="quick-filters">
                <button class="btn btn-sm btn-secondary" data-range="active">Active Week</button>
                <button class="btn btn-sm btn-secondary" data-range="today">Today</button>
                <button class="btn btn-sm btn-secondary" data-range="upcoming">Upcoming</button>
                <button class="btn btn-sm btn-secondary" data-range="past7">Past 7 days</button>
                <button class="btn btn-sm btn-secondary" data-range="past30">Past 30 days</button>
                <button class="btn btn-sm btn-secondary" data-range="all">All</button>
            </div>
        </div>
    </div>

    <div class="calendar-section">
        <div id="eventsContainer">
            {% if calendar_items %}
                {% for date_str, items in calendar_items %}
                <div class="calendar-date-group">
                    <h3 class="calendar-date-header" data-date="{{ date_str }}">{{ date_str | format_date }}</h3>
                    <div class="calendar-items-list">
                        {% for item in items %}
                            {% if item.type == 'prayer' %}
                            <div class="calendar-item calendar-item-prayer">
                                <div class="calendar-item-info">
                                    <span class="calendar-item-text">
                                        üôè <a href="{{ url_for('prayer_scheduler') }}?date={{ date_str }}" class="event-link" onclick="saveScrollPosition()">{{ item.member_name }}</a> - {{ item.prayer_type }}
                                    </span>
                                    <span class="calendar-item-state state-{{ item.state.lower() }}">{{ item.state }}</span>
                                </div>
                                <div class="calendar-item-actions">
                                    <button class="btn btn-sm btn-secondary sms-btn" data-phone="{{ item.member_phone }}" data-member-id="{{ item.member_id }}" title="Tap: SMS | Long-press: SMS+">
                                        SMS
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="openReminderSMS({{ item.assignment_id }}, '{{ item.member_phone }}', '{{ date_str }}', '{{ item.prayer_type }}')">
                                        Reminder
                                    </button>
                                </div>
                            </div>
                            {% elif item.type == 'appointment' %}
                            <div class="calendar-item calendar-item-appointment calendar-item-{{ item.conductor.lower() }}">
                                <div class="calendar-item-info">
                                    <span class="calendar-item-text">
                                        <a href="{{ url_for('appointment_scheduler') }}?appointment_id={{ item.appointment_id }}" class="event-link" onclick="saveScrollPosition()">{{ item.time }} - {{ item.member_name }}</a> - {{ item.appointment_type }}
                                        <span class="calendar-item-state state-{{ item.state.lower() }}">{{ item.state }}</span>
                                    </span>
                                </div>
                                <div class="calendar-item-actions">
                                    <button class="btn btn-sm btn-secondary sms-btn" data-phone="{{ item.member_phone }}" data-member-id="{{ item.member_id }}" title="Tap: SMS | Long-press: SMS+">
                                        SMS
                                    </button>
                                    <button class="btn btn-sm btn-secondary"
                                            onclick="openAppointmentReminderSMS({{ item.appointment_id }}, '{{ item.member_phone }}')"
                                            {% if item.state in ['Draft', 'Invited'] %}disabled{% endif %}>
                                        Reminder
                                    </button>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted">No events found for the selected date range</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/events.js') }}"></script>
<script>
function openSMS(phone) {
    if (!phone) {
        alert('No phone number on file for this member');
        return;
    }
    const smsUrl = `sms:${phone}`;
    window.location.href = smsUrl;
}

async function openReminderSMS(assignmentId, phone, date, prayerType) {
    if (!phone) {
        alert('No phone number on file for this member');
        return;
    }

    try {
        const response = await fetch(`/api/assignments/${assignmentId}/reminder-message`);

        if (!response.ok) {
            throw new Error('Failed to get reminder message');
        }

        const result = await response.json();
        const smsUrl = `sms:${phone}?body=${encodeURIComponent(result.message)}`;
        window.location.href = smsUrl;

    } catch (error) {
        console.error('Error opening reminder SMS:', error);
        alert('Failed to open reminder SMS');
    }
}

async function openAppointmentReminderSMS(appointmentId, phone) {
    if (!phone) {
        alert('No phone number on file for this member');
        return;
    }

    try {
        // Send reminder via API (which handles SMS)
        const response = await fetch(`/api/appointments/${appointmentId}/remind`, {
            method: 'POST'
        });

        if (!response.ok) {
            throw new Error('Failed to send reminder');
        }

        const result = await response.json();

    } catch (error) {
        console.error('Error sending reminder:', error);
        alert('Failed to send reminder');
    }
}

// Setup long-press detection for SMS buttons
function setupLongPressSMS() {
    const smsButtons = document.querySelectorAll('.sms-btn');

    smsButtons.forEach(button => {
        let pressTimer;
        let isLongPress = false;

        // Mouse events (desktop)
        button.addEventListener('mousedown', (e) => {
            const phone = button.dataset.phone;
            const memberId = button.dataset.memberId;
            isLongPress = false;
            pressTimer = setTimeout(() => {
                isLongPress = true;
                button.style.opacity = '0.7';
                window.location.href = `/sms-composer?member_id=${encodeURIComponent(memberId)}`;
            }, 500);
        });

        button.addEventListener('mouseup', (e) => {
            const phone = button.dataset.phone;
            clearTimeout(pressTimer);
            button.style.opacity = '';
            if (!isLongPress) {
                openSMS(phone);
            }
        });

        button.addEventListener('mouseleave', (e) => {
            clearTimeout(pressTimer);
            button.style.opacity = '';
        });

        // Touch events (mobile)
        button.addEventListener('touchstart', (e) => {
            const phone = button.dataset.phone;
            const memberId = button.dataset.memberId;
            e.preventDefault();
            isLongPress = false;
            pressTimer = setTimeout(() => {
                isLongPress = true;
                button.style.opacity = '0.7';
                window.location.href = `/sms-composer?member_id=${encodeURIComponent(memberId)}`;
            }, 500);
        });

        button.addEventListener('touchend', (e) => {
            const phone = button.dataset.phone;
            e.preventDefault();
            clearTimeout(pressTimer);
            button.style.opacity = '';
            if (!isLongPress) {
                openSMS(phone);
            }
        });

        button.addEventListener('touchcancel', (e) => {
            clearTimeout(pressTimer);
            button.style.opacity = '';
        });
    });
}

// Initialize long-press on page load
document.addEventListener('DOMContentLoaded', setupLongPressSMS);
</script>
{% endblock %}

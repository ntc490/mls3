{% set member = members_db.get_by_id(assignment.member_id) if assignment.member_id and assignment.member_id > 0 else None %}
{# Determine gender: use member's gender if assigned, otherwise show both genders as candidates #}
{% set gender = member.gender if member else None %}

<div class="assignment-details">
    <!-- Person Bubble -->
    <div class="bubble bubble-person" onclick="selectMember({{ assignment.assignment_id }}, {{ assignment.member_id if assignment.member_id else 'null' }}, '{{ gender if gender else 'null' }}')">
        <label>Person</label>
        <div class="bubble-value">
            {% if member %}
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <div>
                        {{ member.full_name }}
                        {% if member.last_prayer_date %}
                        <span class="date-note">(last: {{ member.last_prayer_date }})</span>
                        {% else %}
                        <span class="date-note">(never)</span>
                        {% endif %}
                    </div>
                    <button class="btn-clear" onclick="event.stopPropagation(); clearMember({{ assignment.assignment_id }})" title="Clear selection">Ã—</button>
                </div>
            {% else %}
                <span class="placeholder">Click to select</span>
            {% endif %}
        </div>
    </div>

    <!-- Date Bubble -->
    <div class="bubble bubble-date" onclick="changeDate({{ assignment.assignment_id }}, '{{ assignment.date }}')">
        <label>Date</label>
        <div class="bubble-value">{{ assignment.date | format_date }}</div>
    </div>

    <!-- Prayer Type Bubble -->
    <div class="bubble bubble-type" onclick="togglePrayerType({{ assignment.assignment_id }}, '{{ assignment.prayer_type }}')">
        <label>Type</label>
        <div class="bubble-value">{{ assignment.prayer_type }}</div>
    </div>

    <!-- State Display -->
    <p class="state-display"><strong>State:</strong> <span class="state-badge state-{{ assignment.state|lower }}">{{ assignment.state }}</span></p>

    <!-- Actions -->
    <div class="actions">
        {% if assignment.state == 'Draft' and assignment.member_id and assignment.member_id > 0 %}
            <button class="btn btn-primary" onclick="sendInvite({{ assignment.assignment_id }})">Invite</button>
        {% elif assignment.state == 'Invited' %}
            <button class="btn btn-success" onclick="updateState({{ assignment.assignment_id }}, 'Accepted')">Accept</button>
            <button class="btn btn-danger" onclick="confirmDecline({{ assignment.assignment_id }})">Decline</button>
            <button class="btn btn-secondary" onclick="updateState({{ assignment.assignment_id }}, 'Draft')" title="Go back to Draft to change or resend">Cancel</button>
        {% elif assignment.state == 'Accepted' %}
            <button class="btn btn-primary" onclick="sendReminder({{ assignment.assignment_id }})">Remind</button>
            <button class="btn btn-success" onclick="updateState({{ assignment.assignment_id }}, 'Completed')">Complete</button>
            <button class="btn btn-danger" onclick="updateState({{ assignment.assignment_id }}, 'Draft')">Cancel</button>
        {% elif assignment.state == 'Reminded' %}
            <button class="btn btn-success" onclick="updateState({{ assignment.assignment_id }}, 'Completed')">Complete</button>
            <button class="btn btn-danger" onclick="updateState({{ assignment.assignment_id }}, 'Draft')">Cancel</button>
        {% endif %}
    </div>
</div>

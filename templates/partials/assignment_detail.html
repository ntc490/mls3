{% if assignment %}
{% set member = members_db.get_by_id(assignment.member_id) if assignment.member_id and assignment.member_id > 0 else None %}
{# Determine gender: use member's gender if assigned, otherwise show both genders as candidates #}
{% set gender = member.gender if member else None %}
{% set is_completed = assignment.state == 'Completed' %}

<div class="assignment-details {% if is_completed %}assignment-completed{% endif %}">
    <!-- Person Bubble -->
    <div class="bubble bubble-person {% if is_completed %}bubble-readonly{% endif %}" {% if not is_completed %}onclick="selectMember({{ assignment.assignment_id }}, {{ assignment.member_id if assignment.member_id else 'null' }}, '{{ gender if gender else 'null' }}')"{% endif %}>
{% else %}
{# Empty state - no assignment exists yet #}
<div class="assignment-details">
    <!-- Person Bubble - clickable to create assignment -->
    <div class="bubble bubble-person" onclick="selectMember(null, null, null, {{ slot_number }}, '{{ target_sunday.strftime('%Y-%m-%d') }}')">
{% endif %}
        <label>Person</label>
        <div class="bubble-value">
            {% if assignment and member %}
                <div class="member-display">
                    <div class="member-name-section">
                        {{ member.full_name }}
                        {% if member.last_prayer_date %}
                        <span class="date-note">(last: {{ member.last_prayer_date }})</span>
                        {% else %}
                        <span class="date-note">(never)</span>
                        {% endif %}
                    </div>
                    {% if not is_completed %}
                    <div class="member-actions">
                        <button class="btn-icon btn-info" onclick="event.stopPropagation(); openMemberModal({{ member.member_id }}, '{{ assignment.date }}')" title="Member info">ⓘ</button>
                        <button class="btn-icon btn-clear" onclick="event.stopPropagation(); clearMember({{ assignment.assignment_id }})" title="Clear selection">×</button>
                    </div>
                    {% endif %}
                </div>
            {% else %}
                <span class="placeholder">Click to select</span>
            {% endif %}
        </div>
    </div>

    <!-- Prayer Type Bubble -->
    {% if assignment %}
    <div class="bubble bubble-type {% if is_completed %}bubble-readonly{% endif %}" {% if not is_completed %}onclick="togglePrayerType({{ assignment.assignment_id }}, '{{ assignment.prayer_type }}')"{% endif %}>
    {% else %}
    <div class="bubble bubble-type" onclick="togglePrayerType(null, 'Undecided', {{ slot_number }}, '{{ target_sunday.strftime('%Y-%m-%d') }}')">
    {% endif %}
        <label>Type</label>
        <div class="bubble-value">{% if assignment %}{{ assignment.prayer_type }}{% else %}Undecided{% endif %}</div>
    </div>

    {% if assignment %}
    <!-- State Display -->
    <p class="state-display"><strong>State:</strong> <span class="state-badge state-{{ assignment.state|lower }}">{{ assignment.state }}</span></p>

    <!-- Actions -->
    <div class="actions">
        {% if is_completed %}
            <button class="btn btn-danger" onclick="deleteCompletedAssignment({{ assignment.assignment_id }})">Delete</button>
            <p class="help-text">Changing the date will make this assignment editable again.</p>
        {% elif assignment.state == 'Draft' %}
            {% if assignment.member_id and assignment.member_id > 0 %}
                <button class="btn btn-primary" onclick="sendInvite({{ assignment.assignment_id }})">Invite</button>
            {% endif %}
            <button class="btn btn-secondary btn-sm" onclick="clearSlot({{ assignment.assignment_id }})">Clear Slot</button>
        {% elif assignment.state == 'Invited' %}
            <button class="btn btn-success" onclick="updateState({{ assignment.assignment_id }}, 'Accepted')">Accept</button>
            <button class="btn btn-danger" onclick="confirmDecline({{ assignment.assignment_id }})">Decline</button>
            <button class="btn btn-danger" onclick="deleteAssignment({{ assignment.assignment_id }})">Delete</button>
        {% elif assignment.state == 'Accepted' %}
            <button class="btn btn-primary" onclick="sendReminder({{ assignment.assignment_id }})">Remind</button>
            <button class="btn btn-success" onclick="updateState({{ assignment.assignment_id }}, 'Completed')">Complete</button>
            <button class="btn btn-danger" onclick="deleteAssignment({{ assignment.assignment_id }})">Delete</button>
        {% elif assignment.state == 'Reminded' %}
            <button class="btn btn-primary" onclick="sendReminder({{ assignment.assignment_id }})">Remind</button>
            <button class="btn btn-success" onclick="updateState({{ assignment.assignment_id }}, 'Completed')">Complete</button>
            <button class="btn btn-danger" onclick="deleteAssignment({{ assignment.assignment_id }})">Delete</button>
        {% endif %}
    </div>
    {% else %}
    <!-- Empty state - no actions shown -->
    <p class="state-display"><strong>State:</strong> <span class="state-badge state-draft">Empty</span></p>
    {% endif %}
</div>

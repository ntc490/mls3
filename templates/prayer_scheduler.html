{% extends "base.html" %}

{% block title %}Prayer Scheduler - MLS3{% endblock %}

{% block content %}
<div class="container">
    <h1>Prayer Scheduler</h1>
    <h2>{{ next_sunday | format_date }}</h2>

    <div class="assignments-container">
        <!-- Opening Prayer Card -->
        <div class="assignment-card" id="opening-card" data-prayer-type="Opening">
            <h3>Opening Prayer</h3>

            {% if opening_assignment %}
                {% set assignment = opening_assignment %}
                {% set prayer_type = 'Opening' %}
                {% include 'partials/assignment_detail.html' %}
            {% else %}
                <div class="assignment-empty">
                    <p class="empty-state">No assignment created yet</p>
                    <button class="btn btn-primary" onclick="createAssignment('Opening')">Create Assignment</button>
                </div>
            {% endif %}
        </div>

        <!-- Closing Prayer Card -->
        <div class="assignment-card" id="closing-card" data-prayer-type="Closing">
            <h3>Closing Prayer</h3>

            {% if closing_assignment %}
                {% set assignment = closing_assignment %}
                {% set prayer_type = 'Closing' %}
                {% include 'partials/assignment_detail.html' %}
            {% else %}
                <div class="assignment-empty">
                    <p class="empty-state">No assignment created yet</p>
                    <button class="btn btn-primary" onclick="createAssignment('Closing')">Create Assignment</button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Member Selection Modal -->
<div id="member-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Select Member</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>

        <div class="modal-body">
            <input type="text" id="member-search" class="search-input" placeholder="Search members...">

            <div id="next-up-section">
                <h4>Next Up</h4>
                <div id="next-up-list"></div>
            </div>

            <div id="search-results" style="display: none;">
                <h4>Search Results</h4>
                <div id="search-results-list"></div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    console.log('Prayer scheduler JavaScript loaded');
    const nextSunday = '{{ next_sunday.strftime("%Y-%m-%d") }}';
    console.log('Next Sunday:', nextSunday);
    let currentAssignment = null;
    let currentField = null;

    // Create new assignment
    async function createAssignment(prayerType) {
        try {
            const response = await fetch('/api/assignments/create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    member_id: null,
                    date: nextSunday,
                    prayer_type: prayerType
                })
            });

            if (response.ok) {
                location.reload();
            } else {
                const error = await response.json();
                console.error('Failed to create assignment:', error);
                alert('Failed to create assignment: ' + (error.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error creating assignment:', error);
            alert('Error creating assignment: ' + error.message);
        }
    }

    // Open member selection modal
    async function selectMember(assignmentId, currentMemberId, gender) {
        currentAssignment = assignmentId;
        currentField = 'member';

        const modal = document.getElementById('member-modal');
        modal.style.display = 'flex';

        // Load next-up candidates
        await loadNextUpCandidates(gender);

        // Focus search box
        document.getElementById('member-search').focus();
    }

    // Load next-up candidates
    async function loadNextUpCandidates(gender) {
        const response = await fetch(`/api/candidates/${gender}`);
        const candidates = await response.json();

        const list = document.getElementById('next-up-list');
        list.innerHTML = '';

        candidates.forEach(candidate => {
            const div = document.createElement('div');
            div.className = 'candidate-item';
            div.innerHTML = `
                <strong>${candidate.name}</strong>
                <span class="date-note">(last: ${candidate.last_prayer_date})</span>
            `;
            div.onclick = () => selectCandidate(candidate.id, candidate.name);
            list.appendChild(div);
        });
    }

    // Search members
    let searchTimeout = null;
    document.addEventListener('DOMContentLoaded', () => {
        const searchBox = document.getElementById('member-search');
        if (searchBox) {
            searchBox.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value;

                if (query.length > 0) {
                    searchTimeout = setTimeout(() => searchMembers(query), 300);
                    document.getElementById('next-up-section').style.display = 'none';
                    document.getElementById('search-results').style.display = 'block';
                } else {
                    document.getElementById('next-up-section').style.display = 'block';
                    document.getElementById('search-results').style.display = 'none';
                }
            });
        }
    });

    async function searchMembers(query) {
        const response = await fetch(`/api/members/search?q=${encodeURIComponent(query)}`);
        const results = await response.json();

        const list = document.getElementById('search-results-list');
        list.innerHTML = '';

        results.forEach(member => {
            const div = document.createElement('div');
            div.className = 'candidate-item';
            div.innerHTML = `
                <strong>${member.name}</strong> (${member.gender})
                ${member.last_prayer_date ? `<span class="date-note">(last: ${member.last_prayer_date})</span>` : '<span class="date-note">(never)</span>'}
            `;
            div.onclick = () => selectCandidate(member.id, member.name);
            list.appendChild(div);
        });
    }

    // Select a candidate
    async function selectCandidate(memberId, memberName) {
        if (currentAssignment) {
            const response = await fetch(`/api/assignments/${currentAssignment}/update`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({member_id: memberId})
            });

            if (response.ok) {
                closeModal();
                location.reload();
            }
        }
    }

    // Toggle prayer type
    async function togglePrayerType(assignmentId, currentType) {
        const newType = currentType === 'Opening' ? 'Closing' : 'Opening';

        const response = await fetch(`/api/assignments/${assignmentId}/update`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({prayer_type: newType})
        });

        if (response.ok) {
            location.reload();
        }
    }

    // Update assignment state
    async function updateState(assignmentId, newState) {
        const response = await fetch(`/api/assignments/${assignmentId}/state`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({state: newState})
        });

        if (response.ok) {
            location.reload();
        }
    }

    // Close modal
    function closeModal() {
        document.getElementById('member-modal').style.display = 'none';
        document.getElementById('member-search').value = '';
        document.getElementById('next-up-section').style.display = 'block';
        document.getElementById('search-results').style.display = 'none';
    }

    // Close modal on outside click
    window.onclick = function(event) {
        const modal = document.getElementById('member-modal');
        if (event.target === modal) {
            closeModal();
        }
    }
</script>
{% endblock %}

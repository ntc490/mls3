{% extends "base.html" %}

{% block title %}Prayer Scheduler - MLS3{% endblock %}

{% block content %}
<div class="container">
    <h1>Prayer Scheduler</h1>

    <div class="date-navigation">
        <a href="?date={{ prev_sunday.strftime('%Y-%m-%d') }}" class="btn btn-secondary">← Previous Week</a>
        <h2>{{ target_sunday | format_date }}</h2>
        <a href="?date={{ next_sunday_nav.strftime('%Y-%m-%d') }}" class="btn btn-secondary">Next Week →</a>
    </div>

    <div class="assignments-container">
        <!-- Opening Prayer Card -->
        <div class="assignment-card" id="opening-card" data-prayer-type="Opening">
            <h3>Opening Prayer</h3>

            {% if opening_assignment %}
                {% set assignment = opening_assignment %}
                {% set prayer_type = 'Opening' %}
                {% include 'partials/assignment_detail.html' %}
            {% else %}
                <div class="assignment-empty">
                    <p class="empty-state">No assignment created yet</p>
                    <button class="btn btn-primary" onclick="createAssignment('Opening')">Create Assignment</button>
                </div>
            {% endif %}
        </div>

        <!-- Closing Prayer Card -->
        <div class="assignment-card" id="closing-card" data-prayer-type="Closing">
            <h3>Closing Prayer</h3>

            {% if closing_assignment %}
                {% set assignment = closing_assignment %}
                {% set prayer_type = 'Closing' %}
                {% include 'partials/assignment_detail.html' %}
            {% else %}
                <div class="assignment-empty">
                    <p class="empty-state">No assignment created yet</p>
                    <button class="btn btn-primary" onclick="createAssignment('Closing')">Create Assignment</button>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Active Queue -->
    {% if active_queue and active_queue|length > 0 %}
    <div class="active-queue">
        <h2>Active Queue</h2>
        <p class="queue-description">Future assignments and assignments in progress</p>

        <div class="queue-list">
            {% for queue_item in active_queue %}
            {% set member = members_db.get_by_id(queue_item.member_id) if queue_item.member_id and queue_item.member_id > 0 else None %}
            <div class="queue-item" onclick="window.location.href='#'">
                <div class="queue-item-header">
                    <span class="queue-date">{{ queue_item.date | format_date }}</span>
                    <span class="queue-type">{{ queue_item.prayer_type }}</span>
                    <span class="state-badge state-{{ queue_item.state|lower }}">{{ queue_item.state }}</span>
                </div>
                <div class="queue-item-body">
                    {% if member %}
                        <strong>{{ member.full_name }}</strong>
                        {% if member.phone %}
                        <span class="text-muted">{{ member.phone }}</span>
                        {% endif %}
                    {% else %}
                        <span class="text-muted">No member assigned yet</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Member Selection Modal -->
<div id="member-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Select Member</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>

        <div class="modal-body">
            <input type="text" id="member-search" class="search-input" placeholder="Search members...">

            <div id="next-up-section">
                <h4>Next Up</h4>
                <div id="next-up-list"></div>
            </div>

            <div id="search-results" style="display: none;">
                <h4>Search Results</h4>
                <div id="search-results-list"></div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    console.log('Prayer scheduler JavaScript loaded');
    const nextSunday = '{{ next_sunday.strftime("%Y-%m-%d") }}';
    console.log('Next Sunday:', nextSunday);
    let currentAssignment = null;
    let currentField = null;

    // Show loading indicator
    function showLoading() {
        document.body.style.cursor = 'wait';
    }

    function hideLoading() {
        document.body.style.cursor = 'default';
    }

    // Create new assignment
    async function createAssignment(prayerType) {
        showLoading();
        try {
            const response = await fetch('/api/assignments/create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    member_id: null,
                    date: nextSunday,
                    prayer_type: prayerType
                })
            });

            if (response.ok) {
                location.reload();
            } else {
                const error = await response.json();
                console.error('Failed to create assignment:', error);
                alert('Failed to create assignment: ' + (error.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error creating assignment:', error);
            alert('Error creating assignment: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    // Open member selection modal
    async function selectMember(assignmentId, currentMemberId, gender) {
        currentAssignment = assignmentId;
        currentField = 'member';

        const modal = document.getElementById('member-modal');
        modal.style.display = 'flex';

        // Load next-up candidates
        await loadNextUpCandidates(gender);

        // Focus search box
        document.getElementById('member-search').focus();
    }

    // Load next-up candidates
    async function loadNextUpCandidates(gender) {
        console.log('Loading candidates for gender:', gender);
        const list = document.getElementById('next-up-list');
        list.innerHTML = '';

        // If no gender specified, show both male and female candidates
        if (!gender || gender === 'None' || gender === 'null' || gender === null || gender === undefined) {
            // Load men
            const menResponse = await fetch(`/api/candidates/M`);
            const menCandidates = await menResponse.json();

            const menHeader = document.createElement('h5');
            menHeader.textContent = 'Men';
            menHeader.style.marginTop = '0.5rem';
            menHeader.style.marginBottom = '0.5rem';
            list.appendChild(menHeader);

            menCandidates.forEach(candidate => {
                const div = document.createElement('div');
                div.className = 'candidate-item';
                const agePart = candidate.age !== null && candidate.age !== undefined ? ` (${candidate.age})` : '';
                div.innerHTML = `
                    <strong>${candidate.name}${agePart}</strong>
                    <span class="date-note">(last: ${candidate.last_prayer_date})</span>
                `;
                div.onclick = () => selectCandidate(candidate.id, candidate.name);
                list.appendChild(div);
            });

            // Load women
            const womenResponse = await fetch(`/api/candidates/F`);
            const womenCandidates = await womenResponse.json();

            const womenHeader = document.createElement('h5');
            womenHeader.textContent = 'Women';
            womenHeader.style.marginTop = '1rem';
            womenHeader.style.marginBottom = '0.5rem';
            list.appendChild(womenHeader);

            womenCandidates.forEach(candidate => {
                const div = document.createElement('div');
                div.className = 'candidate-item';
                const agePart = candidate.age !== null && candidate.age !== undefined ? ` (${candidate.age})` : '';
                div.innerHTML = `
                    <strong>${candidate.name}${agePart}</strong>
                    <span class="date-note">(last: ${candidate.last_prayer_date})</span>
                `;
                div.onclick = () => selectCandidate(candidate.id, candidate.name);
                list.appendChild(div);
            });
        } else {
            // Load candidates of specified gender
            const response = await fetch(`/api/candidates/${gender}`);
            const candidates = await response.json();

            candidates.forEach(candidate => {
                const div = document.createElement('div');
                div.className = 'candidate-item';
                const agePart = candidate.age !== null && candidate.age !== undefined ? ` (${candidate.age})` : '';
                div.innerHTML = `
                    <strong>${candidate.name}${agePart}</strong>
                    <span class="date-note">(last: ${candidate.last_prayer_date})</span>
                `;
                div.onclick = () => selectCandidate(candidate.id, candidate.name);
                list.appendChild(div);
            });
        }
    }

    // Search members
    let searchTimeout = null;
    document.addEventListener('DOMContentLoaded', () => {
        const searchBox = document.getElementById('member-search');
        if (searchBox) {
            searchBox.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value;

                if (query.length > 0) {
                    searchTimeout = setTimeout(() => searchMembers(query), 300);
                    document.getElementById('next-up-section').style.display = 'none';
                    document.getElementById('search-results').style.display = 'block';
                } else {
                    document.getElementById('next-up-section').style.display = 'block';
                    document.getElementById('search-results').style.display = 'none';
                }
            });
        }
    });

    async function searchMembers(query) {
        const response = await fetch(`/api/members/search?q=${encodeURIComponent(query)}`);
        const results = await response.json();

        const list = document.getElementById('search-results-list');
        list.innerHTML = '';

        results.forEach(member => {
            const div = document.createElement('div');
            div.className = 'candidate-item';
            const agePart = member.age !== null && member.age !== undefined ? ` (${member.age})` : '';
            div.innerHTML = `
                <strong>${member.name}${agePart}</strong> (${member.gender})
                ${member.last_prayer_date ? `<span class="date-note">(last: ${member.last_prayer_date})</span>` : '<span class="date-note">(never)</span>'}
            `;
            div.onclick = () => selectCandidate(member.id, member.name);
            list.appendChild(div);
        });
    }

    // Select a candidate
    async function selectCandidate(memberId, memberName) {
        if (currentAssignment) {
            const response = await fetch(`/api/assignments/${currentAssignment}/update`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({member_id: memberId})
            });

            if (response.ok) {
                closeModal();
                location.reload();
            }
        }
    }

    // Clear member selection
    async function clearMember(assignmentId) {
        const response = await fetch(`/api/assignments/${assignmentId}/update`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({member_id: 0})
        });

        if (response.ok) {
            location.reload();
        }
    }

    // Toggle prayer type
    async function togglePrayerType(assignmentId, currentType) {
        const newType = currentType === 'Opening' ? 'Closing' : 'Opening';

        const response = await fetch(`/api/assignments/${assignmentId}/update`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({prayer_type: newType})
        });

        if (response.ok) {
            location.reload();
        }
    }

    // Change date
    async function changeDate(assignmentId, currentDate) {
        const newDate = prompt('Enter new date (YYYY-MM-DD):', currentDate);

        if (newDate && newDate !== currentDate) {
            const response = await fetch(`/api/assignments/${assignmentId}/update`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({date: newDate})
            });

            if (response.ok) {
                location.reload();
            } else {
                alert('Failed to update date. Please use format YYYY-MM-DD');
            }
        }
    }

    // Delete completed assignment with confirmation
    async function deleteCompletedAssignment(assignmentId) {
        if (!confirm('Are you sure you want to delete this completed assignment? This action cannot be undone.')) {
            return;
        }

        showLoading();
        try {
            const response = await fetch(`/api/assignments/${assignmentId}/delete`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });

            if (response.ok) {
                location.reload();
            } else {
                hideLoading();
                alert('Failed to delete assignment');
            }
        } catch (error) {
            hideLoading();
            console.error('Error deleting assignment:', error);
            alert('Error deleting assignment: ' + error.message);
        }
    }

    // Confirm decline action
    function confirmDecline(assignmentId) {
        if (confirm('Are you sure the member declined? This will clear the selected person.')) {
            updateState(assignmentId, 'Draft');
        }
    }

    // Update assignment state
    async function updateState(assignmentId, newState) {
        showLoading();
        const response = await fetch(`/api/assignments/${assignmentId}/state`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({state: newState})
        });

        if (response.ok) {
            location.reload();
        } else {
            hideLoading();
            alert('Failed to update state');
        }
    }

    // Send invitation SMS
    async function sendInvite(assignmentId) {
        try {
            const response = await fetch(`/api/assignments/${assignmentId}/invite`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });

            const result = await response.json();

            if (response.ok) {
                // SMS app should have opened
                // State was updated to Invited
                alert('SMS app opened. After sending the message, come back and wait for their response.');
                location.reload();
            } else {
                // Show error with phone number for manual fallback
                if (result.phone && result.member) {
                    alert(`Failed to open SMS app.\n\nPlease manually text ${result.member} at ${result.phone}`);
                } else {
                    alert('Failed to send invitation: ' + (result.error || 'Unknown error'));
                }
            }
        } catch (error) {
            console.error('Error sending invitation:', error);
            alert('Error sending invitation: ' + error.message);
        }
    }

    // Send reminder SMS
    async function sendReminder(assignmentId) {
        try {
            const response = await fetch(`/api/assignments/${assignmentId}/remind`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });

            const result = await response.json();

            if (response.ok) {
                // SMS app should have opened
                // State was updated to Reminded
                alert('SMS app opened. After sending the reminder, come back here.');
                location.reload();
            } else {
                // Show error with phone number for manual fallback
                if (result.phone && result.member) {
                    alert(`Failed to open SMS app.\n\nPlease manually text ${result.member} at ${result.phone}`);
                } else {
                    alert('Failed to send reminder: ' + (result.error || 'Unknown error'));
                }
            }
        } catch (error) {
            console.error('Error sending reminder:', error);
            alert('Error sending reminder: ' + error.message);
        }
    }

    // Close modal
    function closeModal() {
        document.getElementById('member-modal').style.display = 'none';
        document.getElementById('member-search').value = '';
        document.getElementById('next-up-section').style.display = 'block';
        document.getElementById('search-results').style.display = 'none';
    }

    // Close modal on outside click
    window.onclick = function(event) {
        const modal = document.getElementById('member-modal');
        if (event.target === modal) {
            closeModal();
        }
    }
</script>
{% endblock %}
